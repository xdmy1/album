import { supabase } from '../../../lib/supabaseClient'

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  try {
    console.log('Setting up family categories system...')

    // First, test if we can insert into family_categories table
    // If it fails, the table doesn't exist and we'll need manual creation
    
    // Get a test family ID to work with
    const { data: families, error: familiesError } = await supabase
      .from('families')
      .select('id')
      .limit(1)

    if (familiesError || !families || families.length === 0) {
      return res.status(500).json({ 
        error: 'No families found', 
        details: 'Need at least one family to test with'
      })
    }

    const testFamilyId = families[0].id

    // Test insert to check if table exists
    const { data: testInsert, error: testError } = await supabase
      .from('family_categories')
      .insert([{
        family_id: testFamilyId,
        category_value: 'test-setup',
        category_label: 'Test Setup',
        category_emoji: 'ðŸ”§'
      }])

    if (testError) {
      if (testError.message.includes('does not exist') || 
          testError.message.includes('schema cache') ||
          testError.code === '42P01') {
        
        return res.status(400).json({
          error: 'Table does not exist',
          message: 'The family_categories table needs to be created manually in Supabase dashboard',
          sql: `
CREATE TABLE family_categories (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  family_id UUID NOT NULL REFERENCES families(id) ON DELETE CASCADE,
  category_value VARCHAR(100) NOT NULL,
  category_label VARCHAR(200) NOT NULL,
  category_emoji VARCHAR(10) DEFAULT 'ðŸ“',
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE(family_id, category_value)
);

CREATE INDEX idx_family_categories_family_id ON family_categories(family_id);
ALTER TABLE family_categories ENABLE ROW LEVEL SECURITY;
          `.trim(),
          instructions: [
            '1. Go to your Supabase dashboard',
            '2. Navigate to SQL Editor', 
            '3. Run the SQL provided above',
            '4. Try this API again'
          ]
        })
      } else {
        return res.status(500).json({ 
          error: 'Database error', 
          details: testError.message 
        })
      }
    }

    // If we got here, the table exists. Clean up test record
    await supabase
      .from('family_categories')
      .delete()
      .eq('category_value', 'test-setup')

    // Now populate default categories for all families
    const { data: allFamilies, error: allFamiliesError } = await supabase
      .from('families')
      .select('id')

    if (allFamiliesError) {
      return res.status(500).json({ 
        error: 'Error fetching families', 
        details: allFamiliesError.message 
      })
    }

    const defaultCategories = [
      { value: 'memories', label: 'Amintiri', emoji: 'ðŸ’­' },
      { value: 'milestones', label: 'Etape importante', emoji: 'ðŸŽ¯' },
      { value: 'everyday', label: 'Zilnic', emoji: 'â˜€ï¸' },
      { value: 'special', label: 'Special', emoji: 'âœ¨' },
      { value: 'family', label: 'Familie', emoji: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦' },
      { value: 'play', label: 'JoacÄƒ', emoji: 'ðŸŽ®' },
      { value: 'learning', label: 'ÃŽnvÄƒÈ›are', emoji: 'ðŸ“š' }
    ]

    let setupCount = 0
    for (const family of allFamilies) {
      // Check if family already has categories
      const { data: existing, error: existingError } = await supabase
        .from('family_categories')
        .select('id')
        .eq('family_id', family.id)
        .limit(1)

      if (existingError) {
        console.error(`Error checking categories for family ${family.id}:`, existingError)
        continue
      }

      // Only add defaults if family has no categories
      if (!existing || existing.length === 0) {
        const categoriesToInsert = defaultCategories.map(cat => ({
          family_id: family.id,
          category_value: cat.value,
          category_label: cat.label,
          category_emoji: cat.emoji
        }))

        const { error: insertError } = await supabase
          .from('family_categories')
          .insert(categoriesToInsert)

        if (insertError) {
          console.error(`Error inserting categories for family ${family.id}:`, insertError)
        } else {
          setupCount++
          console.log(`Default categories added for family ${family.id}`)
        }
      }
    }

    res.status(200).json({ 
      success: true, 
      message: `Categories setup completed for ${setupCount} families`,
      totalFamilies: allFamilies.length,
      familiesSetup: setupCount
    })

  } catch (error) {
    console.error('Error in setup-categories:', error)
    res.status(500).json({ 
      error: 'Setup failed', 
      details: error.message 
    })
  }
}