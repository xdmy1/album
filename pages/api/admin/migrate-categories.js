import { supabase } from '../../../lib/supabaseClient'
import { requireEditor } from '../../../lib/authMiddleware'

async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' })
  }

  try {
    // Create family_categories table if it doesn't exist
    const { error: createError } = await supabase.rpc('create_family_categories_table')
    
    if (createError && !createError.message.includes('already exists')) {
      // If RPC doesn't exist, create table manually
      const createTableSQL = `
        CREATE TABLE IF NOT EXISTS family_categories (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
          family_id UUID NOT NULL REFERENCES families(id) ON DELETE CASCADE,
          category_value VARCHAR(100) NOT NULL,
          category_label VARCHAR(200) NOT NULL,
          category_emoji VARCHAR(10) DEFAULT 'ðŸ“',
          created_at TIMESTAMPTZ DEFAULT NOW(),
          updated_at TIMESTAMPTZ DEFAULT NOW(),
          UNIQUE(family_id, category_value)
        );
        
        -- Create indexes for better performance
        CREATE INDEX IF NOT EXISTS idx_family_categories_family_id ON family_categories(family_id);
        CREATE INDEX IF NOT EXISTS idx_family_categories_value ON family_categories(family_id, category_value);
        
        -- Create RLS policies
        ALTER TABLE family_categories ENABLE ROW LEVEL SECURITY;
        
        -- Policy for authenticated users to read their family's categories
        CREATE POLICY IF NOT EXISTS "Users can view their family categories" 
        ON family_categories FOR SELECT 
        USING (family_id = auth.jwt() ->> 'family_id'::uuid);
        
        -- Policy for authenticated users to manage their family's categories
        CREATE POLICY IF NOT EXISTS "Users can manage their family categories" 
        ON family_categories FOR ALL 
        USING (family_id = auth.jwt() ->> 'family_id'::uuid);
      `
      
      const { error: sqlError } = await supabase.rpc('exec_sql', { sql: createTableSQL })
      if (sqlError) {
        console.error('SQL Error:', sqlError)
        // Continue anyway, table might already exist
      }
    }

    // Default categories that every family should have
    const DEFAULT_CATEGORIES = [
      { value: 'memories', label: 'Amintiri', emoji: 'ðŸ’­' },
      { value: 'milestones', label: 'Etape importante', emoji: 'ðŸŽ¯' },
      { value: 'everyday', label: 'Zilnic', emoji: 'â˜€ï¸' },
      { value: 'special', label: 'Special', emoji: 'âœ¨' },
      { value: 'family', label: 'Familie', emoji: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§â€ðŸ‘¦' },
      { value: 'play', label: 'JoacÄƒ', emoji: 'ðŸŽ®' },
      { value: 'learning', label: 'ÃŽnvÄƒÈ›are', emoji: 'ðŸ“š' }
    ]

    // Get all families
    const { data: families, error: familiesError } = await supabase
      .from('families')
      .select('id')

    if (familiesError) {
      throw familiesError
    }

    let migratedFamilies = 0

    for (const family of families) {
      try {
        // Check if family already has categories
        const { data: existingCategories } = await supabase
          .from('family_categories')
          .select('id')
          .eq('family_id', family.id)
          .limit(1)

        if (!existingCategories || existingCategories.length === 0) {
          // Insert default categories for this family
          const categoriesToInsert = DEFAULT_CATEGORIES.map(cat => ({
            family_id: family.id,
            category_value: cat.value,
            category_label: cat.label,
            category_emoji: cat.emoji
          }))

          const { error: insertError } = await supabase
            .from('family_categories')
            .insert(categoriesToInsert)

          if (insertError) {
            console.error(`Error inserting categories for family ${family.id}:`, insertError)
          } else {
            migratedFamilies++
          }
        }
      } catch (familyError) {
        console.error(`Error processing family ${family.id}:`, familyError)
      }
    }

    res.status(200).json({
      success: true,
      message: `Categories table created and ${migratedFamilies} families migrated`
    })
  } catch (error) {
    console.error('Migration error:', error)
    res.status(500).json({ error: 'Migration failed', details: error.message })
  }
}

export default requireEditor(handler)